#!/bin/sh

# Source debconf library.
. /usr/share/debconf/confmodule
db_get composer/WEB_USER
WEBUSER=$(echo  $RET | awk -F: '{print $1}')

UPDATEONLY=$1

UPDATE_COMMAND="COMPOSER_HOME=/var/lib/composer composer -n -o --no-dev update "

echo Composer Global Update searching for /usr/*/*/composer.json:


case "$1" in
    "")

	ls /usr/*/*/composer.json  | while read project; do
	    PROJECTDIR=$(dirname $project)

	    echo Updating optimized `basename $PROJECTDIR`
echo executing	    su - $WEBUSER -s /bin/bash \"${UPDATE_COMMAND} -d ${PROJECTDIR}\"
	    su - $WEBUSER -s /bin/bash -c "${UPDATE_COMMAND} -d ${PROJECTDIR}"

	done

    ;;

    -h|--help)

        echo $0 depname - update only projects requiring given dependency 

    ;;

    *)
	egrep -ilr --include=composer.json "$1" /usr/*/*/composer.json | while read project; do
	    PROJECTDIR=$(dirname $project)
	    echo Updating optimized `basename ${PROJECTDIR}` requiring $1
	    echo executing   su - $WEBUSER -s /bin/bash \"${UPDATE_COMMAND} -d ${PROJECTDIR}\"
	    su - $WEBUSER -s /bin/bash -c "${UPDATE_COMMAND} -d ${PROJECTDIR}"
	done

    ;;
esac


